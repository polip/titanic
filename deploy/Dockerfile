# Generated by the vetiver package; edit with care
# Docker file for the plumber API

# --- Builder Stage ---
FROM rocker/r-ver:4.5.1 as builder
ENV RENV_CONFIG_REPOS_OVERRIDE="https://packagemanager.rstudio.com/cran/latest"

# Install system dependencies required for R packages
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
  build-essential \
  gcc \
  g++ \
  git \
  libcurl4-openssl-dev \
  libxml2-dev \
  libglpk-dev \
  libgit2-dev \
  libfontconfig1-dev \
  libfreetype6-dev \
  libpng-dev \
  libjpeg-dev \
  pandoc \
  libicu-dev \
  libsodium-dev \
  libssl-dev \
  libx11-dev \
  make \
  zlib1g-dev \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/*

# Copy renv.lock and restore packages
COPY deploy/renv.lock renv.lock
RUN Rscript -e "install.packages('renv')" \
  && Rscript -e "renv::restore()"

# --- Runtime Stage ---
FROM rocker/r-ver:4.5.1
ENV RENV_CONFIG_REPOS_OVERRIDE https://packagemanager.rstudio.com/cran/latest

# Copy installed R packages from the builder stage
COPY --from=builder /usr/local/lib/R/site-library/ /usr/local/lib/R/site-library/
COPY --from=builder /usr/local/lib/R/library/ /usr/local/lib/R/library/

# Copy your Plumber API script
COPY deploy/plumber.R /opt/ml/plumber.R

EXPOSE 8000
ENTRYPOINT ["R", "-e", "pr <- plumber::plumb('/opt/ml/plumber.R'); pr$run(host = '0.0.0.0', port = 8000)"]
